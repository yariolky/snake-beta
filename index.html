<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Snake University — Beta</title>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.js"></script>
  <link rel="icon" type="image/png" href="assets/ui/favicon.png">

 <style>
  /* ===== Reset base ===== */
  html, body {
    height: 100%;
    margin: 0;
    color: #eee;
    font-family: system-ui, Arial;
    overflow: hidden;
  }

  /* ===== Fondo difuminado a pantalla completa ===== */
  body {
    background: transparent;      /* importante: sin negro sólido */
    position: relative;
  }

  body::before {
    content: "";
    position: fixed;
    inset: 0;
    /* pon aquí la ruta REAL de tu imagen difuminada */
    background: url("assets/ui/menu_bg_blur.png") center/cover no-repeat;
    filter: blur(14px) brightness(0.6);
    z-index: -1;                  /* detrás del juego, pero visible */
  }

  /* Capa oscura suave para mejorar contraste */
  body::after {
    content: "";
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.3);
    z-index: -1;
  }

  /* Contenedor del juego por encima del fondo */
  #game {
    position: relative;
    width: 100%;
    height: 100%;
    z-index: 0;
  }

  canvas {
    display: block;
    margin: 0 auto;               /* centra el tablero */
  }
</style>


</head>
<body>
<div id="game"></div>

<script>
/* ========= Config base ========= */
const CELL = 20;
const COLS = 25, ROWS = 25;
const WIDTH = COLS * CELL, HEIGHT = ROWS * CELL;

const STUDY_TARGET   = 15; // estudio
const EXAM_TARGET    = 5;  // examenes
const DIPLOMA_TARGET = 1;  // diplomas

const COOLDOWN_SECONDS = 30;

/* ==== Estado Global (indice academico/cooldown) ==== */
window.GAME_LIVES_INIT = 4;
if (typeof window.gameLives === 'undefined') window.gameLives = window.GAME_LIVES_INIT;
if (typeof window.cooldownUntil === 'undefined') window.cooldownUntil = null;

/* ========= Helpers ========= */
function toggleFullscreen(scene){
  if (scene.scale.isFullscreen) scene.scale.stopFullscreen();
  else scene.scale.startFullscreen();
}
function nowSeconds(){ return Math.floor(Date.now()/1000); }
function pad(n){ return n < 10 ? '0' + n : '' + n; }

/* ========= Escenas ========= */

class BootScene extends Phaser.Scene {
  constructor(){ super('Boot'); }
  create(){ this.scene.start('Load'); }
}

class LoadScene extends Phaser.Scene {
  constructor(){ super('Load'); }
  preload(){
    // Audio
    this.load.audio('menuMusic',    'assets/audio/menu_music.mp3');
    this.load.audio('pickup',       'assets/audio/pickup.wav');
    this.load.audio('hit',          'assets/audio/hit.wav');
    this.load.audio('win',          'assets/audio/win.wav');
    this.load.audio('pause',    'assets/audio/pause.wav');

    // Música por fase (usa .mp3 o .wav según tus archivos)
    this.load.audio('phaseStudy',   'assets/audio/phase_study.wav');
    this.load.audio('phaseExam',    'assets/audio/phase_exam.wav');
    this.load.audio('phaseDiploma', 'assets/audio/phase_diploma.wav');

    // Sprites
    this.load.image('menuBg',      'assets/sprites/menu_bg.png');
    this.load.image('snakeHead',   'assets/sprites/snake_head.png');
    this.load.image('book',        'assets/sprites/book.png');
    this.load.image('exam',        'assets/sprites/exam.png');
    this.load.image('diploma',     'assets/sprites/diploma.png');
    this.load.image('enemySprite', 'assets/sprites/enemy.png');
    this.load.image('obstacleSp',  'assets/sprites/obstacle.png');
  }
  create(){
    this.scene.start('Menu');
  }
}

class MenuScene extends Phaser.Scene {
  constructor(){ super('Menu'); }

  create(){
    // Detener música previa
    this.sound.stopAll();

    // ====== FONDO =========
    if (this.textures.exists('menuBg')) {
      this.add.image(WIDTH/2, HEIGHT/2, 'menuBg')
        .setDisplaySize(WIDTH, HEIGHT)
        .setDepth(0);
        // Panel semitransparente para mejorar la lectura del texto
const panel = this.add.rectangle(
  WIDTH/2,
  HEIGHT/2 + 110,           // posición vertical aproximada del bloque de texto
  WIDTH - 80,               // ancho del panel
  140,                      // alto del panel
  0x000000,
  0.55                      // transparencia
).setOrigin(0.5).setDepth(1);

    } else {
      this.add.rectangle(WIDTH/2, HEIGHT/2, WIDTH, HEIGHT, 0x000000)
        .setOrigin(0.5)
        .setDepth(0);
    }


    // ====== TEXTO DE VIDAS / ÍNDICE ACADÉMICO ======
    this.livesText = this.add.text(
      WIDTH/2,
      HEIGHT/2 + 55,
      `índice académico: ${window.gameLives}`,
      {
        fontSize:'22px',
        color:'#98fb98',
        fontStyle:'bold',
        stroke:'#000',
        strokeThickness:4
      }
    ).setOrigin(0.5).setDepth(2);

    // ====== INSTRUCCIONES ======
    this.info = this.add.text(
      WIDTH/2,
      HEIGHT/2 + 120,
      'Flechas / WASD: mover\nEnter: iniciar\nP: pausa\nF: pantalla completa',
      {
        fontSize:'18px',
        color:'#ffffff',
        align:'center',
        stroke:'#000',
        strokeThickness:3
      }
    ).setOrigin(0.5).setDepth(2);

    // Texto de cooldown
    this.coolText = this.add.text(WIDTH/2, HEIGHT/2 + 200, '', {
      fontSize:'18px',
      color:'#ffcc66',
      align:'center',
      stroke:'#000',
      strokeThickness:3
    }).setOrigin(0.5).setDepth(2);

    // ====== MÚSICA DEL MENÚ ======
    if (!this.menuMusic || !this.menuMusic.isPlaying) {
      this.menuMusic = this.sound.add('menuMusic', { loop:true, volume:0.4 });
      if (!this.sound.locked) this.menuMusic.play();
      else this.sound.once(Phaser.Sound.Events.UNLOCKED, () => this.menuMusic.play());
    }

    // ====== BOTÓN DE MUTE ======
    this.isMuted = false;
   const muteBtn = this.add.text(WIDTH/2, HEIGHT - 30, '[MUTEAR]', {
  fontSize:'14px',
  color:'#ffffff',
  backgroundColor:'#000000',
  padding:{ x:10, y:4 }
})
  .setOrigin(0.5)
  .setDepth(2)
  .setAlpha(0.9);

    muteBtn.on('pointerup', () => {
      this.isMuted = !this.isMuted;
      this.sound.mute = this.isMuted;
      muteBtn.setText(this.isMuted ? '[DESMUTEAR]' : '[MUTEAR]');
    });

    // ====== COOLDOWN ======
    if (window.cooldownUntil && nowSeconds() < window.cooldownUntil) {
      this.blocked = true;
      this.updateCooldownText();
      this.coolTimer = this.time.addEvent({
        delay: 1000,
        loop: true,
        callback: () => {
          if (nowSeconds() >= window.cooldownUntil) {
            window.cooldownUntil = null;
            window.gameLives = window.GAME_LIVES_INIT;
            this.blocked = false;
            this.coolText.setText('¡Índice restaurado! Enter para jugar.');
            this.livesText.setText(`índice académico: ${window.gameLives}`);
            this.time.delayedCall(1500, () => this.coolText.setText(''));
          } else {
            this.updateCooldownText();
          }
        }
      });
    } else {
      this.blocked = false;
    }

    // ====== CONTROLES ======
    this.input.keyboard.on('keydown-ENTER', () => {
      if (this.blocked) return;
      if (this.menuMusic) this.menuMusic.stop();
      this.scene.start('Play');
    });

    this.input.keyboard.on('keydown-F', () => toggleFullscreen(this));
  }

  updateCooldownText(){
    const remain = Math.max(0, window.cooldownUntil - nowSeconds());
    this.coolText.setText(`Espera ${remain}s para volver a jugar.`);
  }
}

class PlayScene extends Phaser.Scene {
  constructor(){ super('Play'); }

  create(){
    // Detener cualquier sonido previo (menú, etc.)
    this.sound.stopAll();

    // Estado base
    this.score = 0;
    this.phase = 'study'; // 'study' | 'exam' | 'diploma'
    this.studyCount   = 0;
    this.examCount    = 0;
    this.diplomaCount = 0;

    this.speedMs        = 120;
    this.examSpeedMs    = 90;
    this.diplomaSpeedMs = 70;
    this.lastMove = 0;

    this.dir     = { x: 1, y: 0 };
    this.nextDir = { x: 1, y: 0 };

    // Serpiente: posiciones en la cuadrícula
    this.snake = [
      { x: 5, y: 12 },
      { x: 4, y: 12 },
      { x: 3, y: 12 }
    ];

    this.enemy    = null;
    this.obstacle = null;

    // Entrada
    this.cursors = this.input.keyboard.createCursorKeys();
    // Controles WASD
this.keys = this.input.keyboard.addKeys({
  up: 'W',
  left: 'A',
  down: 'S',
  right: 'D'
});


    // Comida inicial
    this.food = this.spawnFood();

    // Temporizador de nivel
    this.levelSeconds = 0;
    this.timerEvent = this.time.addEvent({
      delay: 1000,
      loop: true,
      callback: () => {
        this.levelSeconds++;
        this.hud.setText(this.hudText());
      }
    });

    // HUD
    this.hud = this.add.text(8, 8, this.hudText(), {
      fontSize:'14px', color:'#ffffff'
    }).setDepth(10);

    // Overlay mensajes
    this.overlay = this.add.text(WIDTH/2, HEIGHT/2, '', {
      fontSize:'28px', color:'#ffee88'
    }).setOrigin(0.5).setDepth(20).setVisible(false);

    // Botón de pausa (esquina sup. derecha)
    this.pauseBtn = this.add.text(WIDTH - 80, 24, 'PAUSA', {
      fontSize:'14px',
      color:'#ffffff',
      backgroundColor:'#333',
      padding:{ x:6, y:2 }
    })
      .setDepth(15)
      .setInteractive({ useHandCursor:true })
      .on('pointerup', () => {
        this.sound.play('pause', { volume:0.6 });
        this.scene.launch('Pause', { score: this.score });
        this.scene.pause();
      });

    this.input.keyboard.on('keydown-P', () => {
      this.sound.play('pause', { volume:0.6 });
      this.scene.launch('Pause', { score: this.score });
      this.scene.pause();
    });
    this.input.keyboard.on('keydown-F', () => toggleFullscreen(this));

    // Graphics para fondo / rejilla
    this.gfx = this.add.graphics();

    // Sprites dinámicos
    this.foodSprite     = null;
    this.headSprite     = null;
    this.enemySprite    = null;
    this.obstacleSprite = null;

    // BGM por fase
    this.currentBgm = null;
    this.playPhaseBgm('study');

    // Primer dibujo
    this.drawAll();
  }

  /* === BGM por fase === */
  playPhaseBgm(phase){
    const keyMap = {
      study:   'phaseStudy',
      exam:    'phaseExam',
      diploma: 'phaseDiploma'
    };
    const key = keyMap[phase];
    if (!key) return;

    if (this.currentBgm) {
      this.currentBgm.stop();
      this.currentBgm.destroy();
      this.currentBgm = null;
    }

    this.currentBgm = this.sound.add(key, { loop:true, volume:0.6 });
    this.currentBgm.play();
  }

  stopPhaseBgm(){
    if (this.currentBgm){
      this.currentBgm.stop();
      this.currentBgm.destroy();
      this.currentBgm = null;
    }
  }

  hudText(){
    const mm = pad(Math.floor(this.levelSeconds/60));
    const ss = pad(this.levelSeconds%60);
    return `indice academico: ${window.gameLives}  |  Tiempo: ${mm}:${ss}  |  calificacion: ${this.score}
estudio: (${this.studyCount}/${STUDY_TARGET})  examenes: (${this.examCount}/${EXAM_TARGET})  diplomas: (${this.diplomaCount}/${DIPLOMA_TARGET})`;
  }

  randomFreeCell(){
    const occupied = new Set(this.snake.map(s => `${s.x},${s.y}`));
    if (this.enemy)    occupied.add(`${this.enemy.x},${this.enemy.y}`);
    if (this.obstacle) occupied.add(`${this.obstacle.x},${this.obstacle.y}`);

    let fx, fy, guard = 0;
    do {
      fx = Math.floor(Math.random() * COLS);
      fy = Math.floor(Math.random() * ROWS);
      guard++;
      if (guard > 2000) break;
    } while (occupied.has(`${fx},${fy}`));
    return { x: fx, y: fy };
  }

  spawnFood(){
    const p = this.randomFreeCell();
    let type = 'study';
    if (this.phase === 'exam')    type = 'exam';
    if (this.phase === 'diploma') type = 'diploma';
    return { x: p.x, y: p.y, type };
  }

  spawnEnemy(){
    const p = this.randomFreeCell();
    this.enemy = { x: p.x, y: p.y };
  }

  moveEnemyTowardHead(){
    if (!this.enemy) return;
    const head = this.snake[0];
    const dx = head.x - this.enemy.x;
    const dy = head.y - this.enemy.y;

    if (Math.abs(dx) > Math.abs(dy)){
      this.enemy.x += (dx > 0) ? 1 : -1;
    } else if (Math.abs(dy) > 0){
      this.enemy.y += (dy > 0) ? 1 : -1;
    }

    this.enemy.x = Phaser.Math.Clamp(this.enemy.x, 0, COLS-1);
    this.enemy.y = Phaser.Math.Clamp(this.enemy.y, 0, ROWS-1);

    if (this.food && this.enemy.x === this.food.x && this.enemy.y === this.food.y){
      this.food = this.spawnFood();
    }
  }

  spawnObstacleForDiploma(){
    const p = this.randomFreeCell();
    const dirs = [
      {x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}
    ];
    const d = dirs[Math.floor(Math.random()*dirs.length)];
    this.obstacle = { x: p.x, y: p.y, vx: d.x, vy: d.y };
  }

moveObstacle(){
  if (!this.obstacle) return;

  let nx = this.obstacle.x + this.obstacle.vx;
  let ny = this.obstacle.y + this.obstacle.vy;

  if (nx < 0 || nx >= COLS) {
    this.obstacle.vx *= -1;
    nx = this.obstacle.x + this.obstacle.vx;
  }
  if (ny < 0 || ny >= ROWS) {
    this.obstacle.vy *= -1;
    ny = this.obstacle.y + this.obstacle.vy;
  }

  this.obstacle.x = nx;
  this.obstacle.y = ny;

  // Si el obstáculo cae encima de la cabeza, también es derrota
  const head = this.snake[0];
  if (head && head.x === this.obstacle.x && head.y === this.obstacle.y){
    this.onLose('Obstáculo');
    return;
  }

  if (this.food && this.obstacle.x === this.food.x && this.obstacle.y === this.food.y){
    this.food = this.spawnFood();
  }
}


  update(time){
    // Input
   // Input (Flechas + WASD)
if ((this.cursors.left.isDown  || this.keys.left.isDown)  && this.dir.x !== 1)  {
  this.nextDir = { x:-1, y: 0 };
}
if ((this.cursors.right.isDown || this.keys.right.isDown) && this.dir.x !== -1) {
  this.nextDir = { x: 1, y: 0 };
}
if ((this.cursors.up.isDown    || this.keys.up.isDown)    && this.dir.y !== 1)  {
  this.nextDir = { x: 0, y:-1 };
}
if ((this.cursors.down.isDown  || this.keys.down.isDown)  && this.dir.y !== -1) {
  this.nextDir = { x: 0, y: 1 };
}

    const tick =
      this.phase === 'study'   ? this.speedMs :
      this.phase === 'exam'    ? this.examSpeedMs :
                                  this.diplomaSpeedMs;

    if (time - this.lastMove < tick) return;
    this.lastMove = time;
    this.dir = this.nextDir;

    if (this.phase !== 'study') this.moveEnemyTowardHead();
    if (this.phase === 'diploma') this.moveObstacle();

    // Nueva cabeza
    const head = {
      x: this.snake[0].x + this.dir.x,
      y: this.snake[0].y + this.dir.y
    };

    // Colisiones duras
    if (head.x < 0 || head.x >= COLS || head.y < 0 || head.y >= ROWS) {
      return this.onLose('Pared');
    }
    for (let i=0;i<this.snake.length;i++){
      if (this.snake[i].x === head.x && this.snake[i].y === head.y){
        return this.onLose('Autocolisión');
      }
    }
    if (this.enemy && head.x === this.enemy.x && head.y === this.enemy.y){
      return this.onLose('Enemigo IA');
    }
    if (this.phase === 'diploma' && this.obstacle &&
        head.x === this.obstacle.x && head.y === this.obstacle.y){
      return this.onLose('Obstáculo');
    }

    this.snake.unshift(head);

    // Comer
    if (head.x === this.food.x && head.y === this.food.y){
      this.sound.play('pickup', { volume:0.6 });

      this.score += (this.phase === 'study') ? 10 :
                    (this.phase === 'exam')  ? 20 : 30;

      if (this.phase === 'study') {
        this.studyCount++;
        if (this.studyCount >= STUDY_TARGET) {
          this.phase = 'exam';
          this.playPhaseBgm('exam');
          this.overlay.setText('¡Hora de examen! (IA activada)').setVisible(true);
          this.time.delayedCall(1000, () => this.overlay.setVisible(false));
          this.spawnEnemy();
        }
      } else if (this.phase === 'exam') {
        this.examCount++;
        if (this.examCount >= EXAM_TARGET) {
          this.phase = 'diploma';
          this.playPhaseBgm('diploma');
          this.overlay.setText('¡Recoge el diploma!').setVisible(true);
          this.time.delayedCall(1200, () => this.overlay.setVisible(false));
          if (!this.enemy) this.spawnEnemy();
          this.spawnObstacleForDiploma();
        }
      } else {
        this.diplomaCount++;
        if (this.diplomaCount >= DIPLOMA_TARGET) {
          this.stopPhaseBgm();
          this.scene.start('Win', { score: this.score });
          return;
        }
      }

      this.food = this.spawnFood();
    } else {
      this.snake.pop();
    }

    this.hud.setText(this.hudText());
    this.drawAll();
  }

  onLose(reason){
    this.stopPhaseBgm();
    this.sound.play('hit', { volume:0.8 });

    window.gameLives = Math.max(0, window.gameLives - 1);
    if (window.gameLives > 0){
      this.scene.start('GameOver', {
        score: this.score,
        reason: `${reason} (indice academico restante: ${window.gameLives})`
      });
    } else {
      window.cooldownUntil = nowSeconds() + COOLDOWN_SECONDS;
      this.scene.start('GameOver', {
        score: this.score,
        reason: `${reason} (indice academico: 0)`
      });
    }
  }

  drawAll(){
    // Fondo
    this.gfx.clear();
    this.gfx.fillStyle(0x202020).fillRect(0,0,WIDTH,HEIGHT);

    // Rejilla
   this.gfx.lineStyle(1, 0x000000, 0.05); // casi invisible

    // Helpers de centro de celda
    const cx = (gx) => gx*CELL + CELL/2;
    const cy = (gy) => gy*CELL + CELL/2;

    // ==== FOOD como sprite (libro/examen/diploma) ====
    let foodKey = 'book';
    if (this.food.type === 'exam')    foodKey = 'exam';
    if (this.food.type === 'diploma') foodKey = 'diploma';

    if (this.textures.exists(foodKey)) {
      if (!this.foodSprite){
        this.foodSprite = this.add.sprite(cx(this.food.x), cy(this.food.y), foodKey);
        this.foodSprite.setDisplaySize(CELL, CELL);
      } else {
        this.foodSprite.setTexture(foodKey);
        this.foodSprite.setPosition(cx(this.food.x), cy(this.food.y));
      }
    } else {
      // fallback: cuadrado
      this.gfx.fillStyle(0xff5555)
        .fillRect(this.food.x*CELL, this.food.y*CELL, CELL, CELL);
    }

 // ==== ENEMIGO (solo sprite, más grande) ====
if (this.enemy){
  if (this.textures.exists('enemySprite')){
    if (!this.enemySprite){
      this.enemySprite = this.add.sprite(cx(this.enemy.x), cy(this.enemy.y), 'enemySprite');
      this.enemySprite.setDisplaySize(CELL * 1.6, CELL * 1.6); // más grande que la celda
    } else {
      this.enemySprite.setPosition(cx(this.enemy.x), cy(this.enemy.y));
    }
  } else {
    // fallback: si no carga la textura, al menos un cuadro
    this.gfx.fillStyle(0xff4444)
      .fillRect(this.enemy.x*CELL, this.enemy.y*CELL, CELL, CELL);
  }
} else if (this.enemySprite){
  this.enemySprite.destroy();
  this.enemySprite = null;
}


    // ==== OBSTÁCULO (solo en diploma) ====
    if (this.phase === 'diploma' && this.obstacle){
      this.gfx.fillStyle(0x9966ff)
        .fillRect(this.obstacle.x*CELL, this.obstacle.y*CELL, CELL, CELL);
      this.gfx.lineStyle(2, 0xffffff, 0.35)
        .strokeRect(this.obstacle.x*CELL+1, this.obstacle.y*CELL+1, CELL-2, CELL-2);

      if (this.textures.exists('obstacleSp')){
        if (!this.obstacleSprite){
          this.obstacleSprite = this.add.sprite(cx(this.obstacle.x), cy(this.obstacle.y), 'obstacleSp');
          this.obstacleSprite.setDisplaySize(CELL, CELL);
        } else {
          this.obstacleSprite.setPosition(cx(this.obstacle.x), cy(this.obstacle.y));
        }
      }
    } else if (this.obstacleSprite){
      this.obstacleSprite.destroy();
      this.obstacleSprite = null;
    }

    // ==== SERPIENTE – cuerpo como rectángulos ====
    this.gfx.fillStyle(0x00cc66);
    this.snake.forEach((seg, idx) => {
      if (idx === 0) return; // cabeza se dibuja aparte
      this.gfx.fillRect(seg.x*CELL, seg.y*CELL, CELL, CELL);
    });

    // ==== CABEZA con sprite ====
    const head = this.snake[0];
    if (this.textures.exists('snakeHead')) {
      if (!this.headSprite){
        this.headSprite = this.add.sprite(cx(head.x), cy(head.y), 'snakeHead');
        this.headSprite.setDisplaySize(CELL, CELL);
      } else {
        this.headSprite.setPosition(cx(head.x), cy(head.y));
      }
    } else {
      this.gfx.fillStyle(0x00ff88)
        .fillRect(head.x*CELL, head.y*CELL, CELL, CELL);
    }
  }
}


class PauseScene extends Phaser.Scene {
  constructor(){ super('Pause'); }
  init(data){ this.score = data.score || 0; }

  create(){
    this.add.rectangle(WIDTH/2, HEIGHT/2, WIDTH, HEIGHT, 0x000000, 0.55).setOrigin(0.5);
    this.add.text(WIDTH/2, HEIGHT/2 - 90, 'Pausa', {
      fontSize:'32px', color:'#ffffff'
    }).setOrigin(0.5);
    this.add.text(WIDTH/2, HEIGHT/2 - 50, `calificacion: ${this.score}`, {
      fontSize:'18px', color:'#dddddd'
    }).setOrigin(0.5);

    const makeBtn = (y, label, onClick) => {
      const t = this.add.text(WIDTH/2, y, label, {
        fontSize:'20px', color:'#ffee88',
        backgroundColor:'#333', padding:{ x:10, y:6 }
      }).setOrigin(0.5).setInteractive({ useHandCursor:true });
      t.on('pointerover', () => t.setStyle({ backgroundColor:'#444' }));
      t.on('pointerout',  () => t.setStyle({ backgroundColor:'#333' }));
      t.on('pointerup', onClick);
      return t;
    };

    makeBtn(HEIGHT/2,          'Reanudar',          () => { this.scene.stop(); this.scene.resume('Play'); });
    makeBtn(HEIGHT/2 + 40,     'Reiniciar',         () => { this.scene.stop('Play'); this.scene.start('Play'); });
    makeBtn(HEIGHT/2 + 80,     'Pantalla completa', () => toggleFullscreen(this));
    makeBtn(HEIGHT/2 + 120,    'Salir al menú',     () => { this.scene.stop('Play'); this.scene.start('Menu'); });

    // Controles de volumen
    let volText = this.add.text(WIDTH/2, HEIGHT/2 + 170, `Volumen: ${Math.round(this.sound.volume*100)}%`, {
      fontSize:'16px', color:'#ffffff'
    }).setOrigin(0.5);

    const volDown = this.add.text(WIDTH/2 - 90, HEIGHT/2 + 140, 'Vol -', {
      fontSize:'16px', color:'#ffee88',
      backgroundColor:'#333', padding:{x:8,y:4}
    }).setOrigin(0.5).setInteractive({useHandCursor:true});

    const volUp = this.add.text(WIDTH/2 + 90, HEIGHT/2 + 140, 'Vol +', {
      fontSize:'16px', color:'#ffee88',
      backgroundColor:'#333', padding:{x:8,y:4}
    }).setOrigin(0.5).setInteractive({useHandCursor:true});

    const updateVolText = () => volText.setText(`Volumen: ${Math.round(this.sound.volume*100)}%`);

    volDown.on('pointerup', () => {
      this.sound.volume = Math.max(0, this.sound.volume - 0.1);
      updateVolText();
    });
    volUp.on('pointerup', () => {
      this.sound.volume = Math.min(1, this.sound.volume + 0.1);
      updateVolText();
    });

    this.input.keyboard.on('keydown-P',   () => { this.scene.stop(); this.scene.resume('Play'); });
    this.input.keyboard.on('keydown-F',   () => toggleFullscreen(this));
    this.input.keyboard.on('keydown-ESC', () => { this.scene.stop('Play'); this.scene.start('Menu'); });
  }
}

class CooldownScene extends Phaser.Scene {
  constructor(){ super('Cooldown'); }
  create(){
    this.add.rectangle(WIDTH/2, HEIGHT/2, WIDTH, HEIGHT, 0x000000, 0.65).setOrigin(0.5);
    this.add.text(WIDTH/2, HEIGHT/2 - 60, 'indice academico agotado', {
      fontSize:'30px', color:'#ffcc66'
    }).setOrigin(0.5);
    this.msg = this.add.text(WIDTH/2, HEIGHT/2 + 0, '', {
      fontSize:'20px', color:'#ffffff'
    }).setOrigin(0.5);

    this.timer = this.time.addEvent({
      delay: 1000,
      loop: true,
      callback: () => {
        if (!window.cooldownUntil) { this.scene.start('Menu'); return; }
        const remain = window.cooldownUntil - nowSeconds();
        if (remain <= 0){
          window.cooldownUntil = null;
          window.gameLives = window.GAME_LIVES_INIT;
          this.msg.setText('¡indice academico restaurado! Pulsa Enter en el Menú.');
          this.time.delayedCall(1200, () => this.scene.start('Menu'));
        } else {
          this.msg.setText(`Podrás jugar en ${remain}s`);
        }
      }
    });

    this.input.keyboard.on('keydown-ENTER', () => this.scene.start('Menu'));
    this.input.keyboard.on('keydown-ESC',   () => this.scene.start('Menu'));
  }
}

class GameOverScene extends Phaser.Scene {
  constructor(){ super('GameOver'); }
  init(data){
    this.finalScore = data.score || 0;
    this.reason     = data.reason || 'Fin';
  }
  create(){
    this.add.rectangle(WIDTH/2, HEIGHT/2, WIDTH, HEIGHT, 0x0a0a0a).setOrigin(0.5);
    // Imagen central para que no se vea tan vacío
if (this.textures.exists('enemySprite')) {
  const profe = this.add.sprite(WIDTH/2, HEIGHT/2 - 110, 'enemySprite');
  profe.setDisplaySize(100, 100);  // ajústalo si lo quieres más grande/pequeño
} else if (this.textures.exists('snakeHead')) {
  // Fallback: usar la cabeza de la serpiente
  const snake = this.add.sprite(WIDTH/2, HEIGHT/2 - 110, 'snakeHead');
  snake.setDisplaySize(100, 100);
}

    this.add.text(WIDTH/2, HEIGHT/2 - 30, 'Game Over', {
      fontSize:'32px', color:'#ff6b6b'
    }).setOrigin(0.5);

    this.add.text(WIDTH/2, HEIGHT/2, `Motivo: ${this.reason}\ncalificacion: ${this.finalScore}`, {
      fontSize:'18px', color:'#ffffff', align:'center'
    }).setOrigin(0.5);

    const extra = (window.gameLives>0)
      ? `indice academico restante: ${window.gameLives}`
      : `Cooldown: ${COOLDOWN_SECONDS}s`;

    this.add.text(WIDTH/2, HEIGHT/2 + 40, extra, {
      fontSize:'16px', color:'#ffcc66'
    }).setOrigin(0.5);

    this.add.text(WIDTH/2, HEIGHT/2 + 80,
      'Enter: Continuar  |  Esc: Menú  |  F: Pantalla completa',
      { fontSize:'16px', color:'#cccccc' }
    ).setOrigin(0.5);

    this.input.keyboard.once('keydown-ENTER', () => {
      if (window.gameLives>0) this.scene.start('Menu');
      else this.scene.start('Cooldown');
    });
    this.input.keyboard.once('keydown-ESC', () => this.scene.start('Menu'));
    this.input.keyboard.on('keydown-F', () => toggleFullscreen(this));
  }
}

class WinScene extends Phaser.Scene {
  constructor(){ super('Win'); }
  init(data){ this.finalScore = data.score || 0; }

  create(){
    this.sound.play('win', { volume:0.8 });

    this.add.rectangle(WIDTH/2, HEIGHT/2, WIDTH, HEIGHT, 0x0a0a0a).setOrigin(0.5);
    if (this.textures.exists('diploma')) {
  const dip = this.add.sprite(WIDTH/2, HEIGHT/2 - 90, 'diploma');
  dip.setDisplaySize(90, 90);
}

    this.add.text(WIDTH/2, HEIGHT/2 - 30, '¡Diploma obtenido!', {
      fontSize:'32px', color:'#98fb98'
    }).setOrigin(0.5);
    this.add.text(WIDTH/2, HEIGHT/2, `calificacion: ${this.finalScore}`, {
      fontSize:'18px', color:'#ffffff'
    }).setOrigin(0.5);
    this.add.text(WIDTH/2, HEIGHT/2 + 60,
      'Enter: Jugar de nuevo  |  Esc: Menú  |  F: Pantalla completa',
      { fontSize:'16px', color:'#cccccc' }
    ).setOrigin(0.5);

    this.input.keyboard.once('keydown-ENTER', () => this.scene.start('Menu'));
    this.input.keyboard.once('keydown-ESC',   () => this.scene.start('Menu'));
    this.input.keyboard.on('keydown-F',       () => toggleFullscreen(this));
  }
}

/* ========= Config Phaser ========= */
const config = {
  type: Phaser.AUTO,
  parent: 'game',
  backgroundColor: '#000000',
  scale: {
    mode: Phaser.Scale.FIT,
    autoCenter: Phaser.Scale.CENTER_BOTH,
    width: WIDTH,
    height: HEIGHT
  },
  scene: [
    BootScene,
    LoadScene,
    MenuScene,
    PlayScene,
    PauseScene,
    CooldownScene,
    GameOverScene,
    WinScene
  ]
};

new Phaser.Game(config);
</script>
</body>
</html>
